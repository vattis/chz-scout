# ============================================
# CD (Continuous Deployment) 워크플로우
# ============================================
# main 브랜치에 push/merge 시 자동으로 EC2에 배포
#
# 필요한 GitHub Secrets:
#   - DOCKERHUB_USERNAME: Docker Hub 사용자명
#   - DOCKERHUB_TOKEN: Docker Hub Access Token
#   - EC2_HOST: EC2 퍼블릭 IP 또는 도메인
#   - EC2_USERNAME: EC2 SSH 사용자명 (보통 ubuntu)
#   - EC2_SSH_KEY: EC2 .pem 키 내용

name: CD

on:
  push:
    branches: [main]
  # 수동 실행 허용
  workflow_dispatch:

env:
  IMAGE_NAME: chz-scout
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ============================================
  # Job 1: 빌드 & Docker Hub 푸시
  # ============================================
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Job 2: EC2 배포
  # ============================================
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push  # build-and-push 완료 후 실행

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 프로젝트 디렉토리로 이동
            cd ~/chz-scout

            # 최신 코드 가져오기 (docker-compose 파일 등)
            git pull origin main

            # 환경변수 설정
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            export IMAGE_TAG=${{ github.sha }}

            # [Pull 전] 디스크 공간 확보 (미사용 이미지, 컨테이너, 볼륨 정리)
            docker system prune -af --volumes || true

            # 새 이미지 가져오기
            docker compose -f docker-compose.yml -f docker-compose.prod.yml pull app

            # 컨테이너 강제 재생성 (새 이미지 적용 보장)
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate --no-deps app

            # [Pull 후] 교체된 이전 이미지 정리
            docker image prune -af

            # 배포된 이미지 버전 확인
            echo "=== Deployed Image ==="
            docker ps --filter "name=chz-scout-app" --format "{{.Image}}"

            # 배포 상태 확인
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
