# ============================================
# chz-scout Docker Compose - Production Override
# ============================================
# 사용법: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# 이 파일은 docker-compose.yml을 오버라이드하여 프로덕션 환경을 구성합니다.
# - App: Docker Hub 이미지 사용
# - Nginx: HTTPS 리버스 프록시
# - Certbot: Let's Encrypt 인증서 자동 갱신

services:
  # ============================================
  # App 서비스 오버라이드
  # ============================================
  app:
    # Docker Hub에서 빌드된 이미지 사용 (로컬 빌드 대신)
    image: ${DOCKERHUB_USERNAME:-username}/chz-scout:${IMAGE_TAG:-latest}
    # 빌드 설정 제거 (이미지 사용)
    build: !reset null
    # 외부 포트 노출 제거 (Nginx를 통해서만 접근)
    ports: !reset
      - "8080"
    # Nginx가 추가되므로 의존성 유지
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================
  # Nginx 리버스 프록시
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: chz-scout-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Nginx 설정 파일
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Let's Encrypt 인증서
      - ./certbot/conf:/etc/letsencrypt:ro
      # Certbot 웹루트 (인증서 발급/갱신용)
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - app
    networks:
      - chz-scout-network
    # 헬스체크
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Certbot (SSL 인증서 자동 갱신)
  # ============================================
  certbot:
    image: certbot/certbot
    container_name: chz-scout-certbot
    restart: unless-stopped
    volumes:
      # 인증서 저장 위치
      - ./certbot/conf:/etc/letsencrypt
      # 웹루트 인증용
      - ./certbot/www:/var/www/certbot
    # 12시간마다 인증서 갱신 체크 (Let's Encrypt 권장)
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $$!; done;'"
    networks:
      - chz-scout-network

# ============================================
# 프로덕션용 볼륨 추가
# ============================================
volumes:
  certbot-conf:
  certbot-www:
